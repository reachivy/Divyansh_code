<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>🎓 helloIVY Career Selector</title>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            height: 100vh;
            overflow: hidden;
            color: #1a202c;
        }

        .container {
            display: flex;
            height: 100vh;
            max-width: 1400px;
            margin: 0 auto;
            background: rgba(255,255,255,0.05);
            backdrop-filter: blur(10px);
        }

        .conversation-panel {
            flex: 1;
            background: rgba(255,255,255,0.95);
            display: flex;
            flex-direction: column;
            border-right: 1px solid rgba(255,255,255,0.2);
            backdrop-filter: blur(20px);
        }

        .conversation-header {
            padding: 25px 30px;
            border-bottom: 1px solid #e2e8f0;
            background: rgba(255,255,255,0.9);
            backdrop-filter: blur(10px);
        }

        .session-title {
            font-size: 20px;
            font-weight: 700;
            color: #2d3748;
            margin-bottom: 8px;
        }

        .session-timer {
            font-size: 14px;
            color: #718096;
            font-weight: 500;
        }

        .conversation-area {
            flex: 1;
            display: flex;
            flex-direction: column;
            overflow: hidden;
        }

        .messages-container {
            flex: 1;
            overflow-y: auto;
            padding: 25px 30px;
            background: rgba(255,255,255,0.02);
        }

        .message {
            margin-bottom: 25px;
            display: flex;
            gap: 15px;
            animation: slideIn 0.4s ease-out;
            opacity: 0;
            animation-fill-mode: forwards;
        }

        @keyframes slideIn {
            from { opacity: 0; transform: translateY(15px); }
            to { opacity: 1; transform: translateY(0); }
        }

        .avatar {
            width: 42px;
            height: 42px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: 700;
            font-size: 14px;
            color: white;
            flex-shrink: 0;
            box-shadow: 0 4px 12px rgba(0,0,0,0.15);
        }

        .ai-avatar {
            background: linear-gradient(135deg, #667eea, #764ba2);
        }

        .user-avatar {
            background: linear-gradient(135deg, #4facfe, #00f2fe);
        }

        .message-content {
            flex: 1;
            min-width: 0;
        }

        .message-text {
            background: #f7fafc;
            padding: 16px 20px;
            border-radius: 18px;
            line-height: 1.6;
            color: #2d3748;
            border: 1px solid #e2e8f0;
            font-size: 15px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.05);
        }

        .message.user .message-text {
            background: linear-gradient(135deg, #ebf8ff, #e6fffa);
            border-color: #bee3f8;
        }

        .message-time {
            font-size: 12px;
            color: #a0aec0;
            margin-top: 6px;
            margin-left: 20px;
        }

        .live-transcript {
            background: rgba(247, 250, 252, 0.95);
            border-top: 1px solid #e2e8f0;
            padding: 20px 30px;
            min-height: 90px;
            backdrop-filter: blur(10px);
        }

        .transcript-label {
            font-size: 12px;
            color: #718096;
            font-weight: 600;
            margin-bottom: 10px;
            text-transform: uppercase;
            letter-spacing: 0.8px;
        }

        .transcript-text {
            font-size: 16px;
            color: #2d3748;
            line-height: 1.5;
            min-height: 28px;
            font-weight: 500;
        }

        .transcript-text.listening {
            color: #4299e1;
            font-style: italic;
        }

        .transcript-text.processing {
            color: #ed8936;
        }

        .transcript-text.speaking {
            color: #9f7aea;
            font-style: italic;
        }

        .transcript-text.error {
            color: #e53e3e;
        }

        .input-controls {
            padding: 25px 30px;
            background: rgba(255,255,255,0.95);
            border-top: 1px solid #e2e8f0;
            backdrop-filter: blur(10px);
        }

        .input-mode-toggle {
            display: flex;
            align-items: center;
            justify-content: center;
            margin-bottom: 20px;
            gap: 10px;
        }

        .mode-btn {
            padding: 8px 16px;
            border: 2px solid #e2e8f0;
            background: white;
            border-radius: 25px;
            cursor: pointer;
            transition: all 0.3s ease;
            font-size: 14px;
            font-weight: 600;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .mode-btn.active {
            border-color: #667eea;
            background: linear-gradient(135deg, #667eea, #764ba2);
            color: white;
        }

        .mode-btn:hover:not(.active) {
            border-color: #4299e1;
            background: #f7fafc;
        }

        .voice-controls {
            display: flex;
            align-items: center;
            gap: 20px;
        }

        .text-controls {
            display: none;
            flex-direction: column;
            gap: 15px;
        }

        .text-input-container {
            position: relative;
        }

        .text-input {
            width: 100%;
            min-height: 60px;
            padding: 15px 50px 15px 20px;
            border: 2px solid #e2e8f0;
            border-radius: 12px;
            font-size: 16px;
            font-family: inherit;
            resize: vertical;
            transition: all 0.3s ease;
        }

        .text-input:focus {
            outline: none;
            border-color: #667eea;
            box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
        }

        .text-send-btn {
            position: absolute;
            right: 10px;
            top: 50%;
            transform: translateY(-50%);
            width: 36px;
            height: 36px;
            border: none;
            background: linear-gradient(135deg, #667eea, #764ba2);
            color: white;
            border-radius: 50%;
            cursor: pointer;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 16px;
        }

        .text-send-btn:hover {
            transform: translateY(-50%) scale(1.1);
            box-shadow: 0 4px 15px rgba(102, 126, 234, 0.3);
        }

        .text-send-btn:disabled {
            background: #cbd5e0;
            cursor: not-allowed;
            transform: translateY(-50%);
        }

        .mic-button {
            width: 64px;
            height: 64px;
            border-radius: 50%;
            border: none;
            background: linear-gradient(135deg, #667eea, #764ba2);
            color: white;
            font-size: 28px;
            cursor: pointer;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            justify-content: center;
            box-shadow: 0 6px 20px rgba(102, 126, 234, 0.3);
            position: relative;
        }

        .mic-button:hover {
            transform: scale(1.05);
            box-shadow: 0 8px 25px rgba(102, 126, 234, 0.4);
        }

        .mic-button.recording {
            background: linear-gradient(135deg, #fc8181, #f56565);
            animation: pulse 2s infinite;
        }

        .mic-button.processing {
            background: linear-gradient(135deg, #fbb86f, #ed8936);
            animation: spin 1s linear infinite;
        }

        .mic-button.speaking {
            background: linear-gradient(135deg, #9f7aea, #805ad5);
            animation: speaking 1.5s infinite;
        }

        .mic-button.auto-listening {
            background: linear-gradient(135deg, #38b2ac, #319795);
            animation: autoListening 2s infinite;
        }

        @keyframes pulse {
            0%, 100% { transform: scale(1); box-shadow: 0 6px 20px rgba(252, 129, 129, 0.3); }
            50% { transform: scale(1.08); box-shadow: 0 10px 30px rgba(252, 129, 129, 0.5); }
        }

        @keyframes spin {
            from { transform: rotate(0deg); }
            to { transform: rotate(360deg); }
        }

        @keyframes speaking {
            0%, 100% { transform: scale(1); box-shadow: 0 6px 20px rgba(159, 122, 234, 0.3); }
            50% { transform: scale(1.05); box-shadow: 0 8px 25px rgba(159, 122, 234, 0.5); }
        }

        @keyframes autoListening {
            0%, 100% { transform: scale(1); box-shadow: 0 6px 20px rgba(56, 178, 172, 0.3); }
            50% { transform: scale(1.03); box-shadow: 0 8px 25px rgba(56, 178, 172, 0.4); }
        }

        .status-text {
            flex: 1;
            font-size: 15px;
            color: #4a5568;
            font-weight: 600;
        }

        .status-subtext {
            font-size: 13px;
            color: #718096;
            margin-top: 2px;
        }

        .notes-panel {
            width: 420px;
            background: rgba(255,255,255,0.95);
            display: flex;
            flex-direction: column;
            border-left: 1px solid rgba(255,255,255,0.2);
            backdrop-filter: blur(20px);
        }

        .notes-header {
            padding: 25px 30px;
            border-bottom: 1px solid #e2e8f0;
            background: rgba(247, 250, 252, 0.8);
            backdrop-filter: blur(10px);
        }

        .notes-title {
            font-size: 20px;
            font-weight: 700;
            color: #2d3748;
            margin-bottom: 6px;
        }

        .notes-subtitle {
            font-size: 14px;
            color: #718096;
        }

        .notes-content {
            flex: 1;
            overflow-y: auto;
            padding: 20px 30px;
            background: rgba(255,255,255,0.8);
        }

        .note-item {
            background: linear-gradient(135deg, #f7fafc, #edf2f7);
            padding: 14px 16px;
            border-radius: 10px;
            margin-bottom: 10px;
            font-size: 14px;
            line-height: 1.5;
            color: #4a5568;
            border-left: 3px solid #e2e8f0;
            transition: all 0.3s ease;
            box-shadow: 0 2px 4px rgba(0,0,0,0.05);
        }

        .note-item:hover {
            border-left-color: #4299e1;
            background: linear-gradient(135deg, #ebf8ff, #e6fffa);
            transform: translateY(-1px);
            box-shadow: 0 4px 8px rgba(0,0,0,0.1);
        }

        .note-placeholder {
            color: #a0aec0;
            font-style: italic;
            text-align: center;
            padding: 30px 20px;
            font-size: 14px;
        }

        .action-panel {
            padding: 25px 30px;
            border-top: 1px solid #e2e8f0;
            background: rgba(255,255,255,0.9);
            backdrop-filter: blur(10px);
        }

        .generate-career-plan-btn {
            width: 100%;
            padding: 16px 20px;
            background: linear-gradient(135deg, #48bb78, #38a169);
            color: white;
            border: none;
            border-radius: 12px;
            font-size: 15px;
            font-weight: 700;
            cursor: pointer;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 10px;
            box-shadow: 0 4px 15px rgba(72, 187, 120, 0.3);
        }

        .generate-career-plan-btn:hover:not(:disabled) {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(72, 187, 120, 0.4);
        }

        .generate-career-plan-btn:disabled {
            background: linear-gradient(135deg, #e2e8f0, #cbd5e0);
            color: #a0aec0;
            cursor: not-allowed;
            transform: none;
            box-shadow: none;
        }

        .progress-indicator {
            display: flex;
            align-items: center;
            gap: 8px;
            margin-top: 15px;
            padding: 12px 16px;
            background: rgba(102, 126, 234, 0.1);
            border-radius: 8px;
            font-size: 13px;
            color: #667eea;
        }

        .progress-dots {
            display: flex;
            gap: 4px;
        }

        .progress-dot {
            width: 8px;
            height: 8px;
            border-radius: 50%;
            background: #e2e8f0;
            transition: all 0.3s ease;
        }

        .progress-dot.active {
            background: #667eea;
        }

        .typing-indicator {
            display: none;
            align-items: center;
            gap: 8px;
            padding: 12px 20px;
            margin: 10px 0;
            background: #f7fafc;
            border-radius: 18px;
            border: 1px solid #e2e8f0;
        }

        .typing-indicator.active {
            display: flex;
        }

        .typing-dots {
            display: flex;
            gap: 4px;
        }

        .typing-dot {
            width: 8px;
            height: 8px;
            border-radius: 50%;
            background: #cbd5e0;
            animation: typing 1.4s infinite;
        }

        .typing-dot:nth-child(1) { animation-delay: 0s; }
        .typing-dot:nth-child(2) { animation-delay: 0.2s; }
        .typing-dot:nth-child(3) { animation-delay: 0.4s; }

        @keyframes typing {
            0%, 60%, 100% { transform: scale(0.8); opacity: 0.5; }
            30% { transform: scale(1); opacity: 1; }
        }

        .speech-not-supported {
            background: #fed7d7;
            color: #c53030;
            padding: 12px 16px;
            border-radius: 8px;
            margin-bottom: 15px;
            font-size: 14px;
            display: none;
        }

        @media (max-width: 768px) {
            .container { flex-direction: column; height: 100vh; }
            .notes-panel { width: 100%; height: 40vh; }
            .conversation-panel { height: 60vh; }
            .input-controls { padding: 20px; }
            .mic-button { width: 56px; height: 56px; font-size: 24px; }
            .voice-controls { flex-direction: column; gap: 15px; }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="conversation-panel">
            <div class="conversation-header">
                <div class="session-title">🎓 helloIVY Career Selector</div>
                <div class="session-timer" id="sessionTimer">00:00 mins</div>
                <div class="progress-indicator">
                    <span>Conversation Progress:</span>
                    <div class="progress-dots">
                        <div class="progress-dot active" title="Getting Started"></div>
                        <div class="progress-dot" title="Exploring Interests"></div>
                        <div class="progress-dot" title="Career Options"></div>
                        <div class="progress-dot" title="Skills Match"></div>
                        <div class="progress-dot" title="Plan Ready!"></div>
                    </div>
                </div>
            </div>

            <div class="conversation-area">
                <div class="messages-container" id="messagesContainer">
                    <div class="message">
                        <div class="avatar ai-avatar">AI</div>
                        <div class="message-content">
                            <div class="message-text">
                                Hey there! I’m thrilled to be your helloIVY Career Selector buddy! 🌟 Let’s explore awesome careers for kids aged 10-22. What’s your name?
                            </div>
                            <div class="message-time">Just now</div>
                        </div>
                    </div>
                </div>

                <div class="typing-indicator" id="typingIndicator">
                    <div class="avatar ai-avatar" style="width: 24px; height: 24px; font-size: 10px;">AI</div>
                    <div style="color: #718096; font-style: italic;">AI is thinking</div>
                    <div class="typing-dots">
                        <div class="typing-dot"></div>
                        <div class="typing-dot"></div>
                        <div class="typing-dot"></div>
                    </div>
                </div>

                <div class="live-transcript">
                    <div class="transcript-label">🎤 Live Transcript</div>
                    <div class="transcript-text listening" id="liveTranscript">Choose voice or text input to start exploring careers!</div>
                </div>
            </div>

            <div class="input-controls">
                <div class="input-mode-toggle">
                    <button class="mode-btn active" id="voiceModeBtn" onclick="switchToVoiceMode()">
                        🎤 Voice Input
                    </button>
                    <button class="mode-btn" id="textModeBtn" onclick="switchToTextMode()">
                        ⌨️ Text Input
                    </button>
                </div>

                <div class="speech-not-supported" id="speechWarning">
                    ⚠️ Speech recognition is not supported in your browser. Please use text input instead.
                </div>

                <div class="voice-controls" id="voiceControls">
                    <button class="mic-button" id="micButton" onclick="toggleRecording()">🎤</button>
                    <div>
                        <div class="status-text" id="statusText">Ready to start! Click the microphone to begin</div>
                        <div class="status-subtext" id="statusSubtext">Make sure you're in a quiet environment for best results</div>
                    </div>
                </div>

                <div class="text-controls" id="textControls">
                    <div class="text-input-container">
                        <textarea
                            class="text-input"
                            id="textInput"
                            placeholder="Type your response here... Press Enter to send or Shift+Enter for a new line"
                            rows="3"
                        ></textarea>
                        <button class="text-send-btn" id="textSendBtn" onclick="sendTextMessage()" disabled>
                            ➤
                        </button>
                    </div>
                    <div style="font-size: 13px; color: #718096;">
                        💡 Tip: Share your interests or skills to discover careers!
                    </div>
                </div>
            </div>
        </div>

        <div class="notes-panel">
            <div class="notes-header">
                <div class="notes-title">📝 Your Career Notes</div>
                <div class="notes-subtitle">Key insights captured from our conversation</div>
            </div>

            <div class="notes-content" id="notesContent">
                <div class="note-placeholder">Notes will appear here as we chat...</div>
            </div>

            <div class="action-panel">
                <button class="generate-career-plan-btn" id="generateCareerPlanBtn" onclick="generateCareerPlan()">
                    <span>✨</span>
                    <span>Generate Your Career Plan!</span>
                </button>
            </div>
        </div>
    </div>

    <script>
        let currentInputMode = 'voice';
        let isRecording = false;
        let sessionStartTime = Date.now();
        let conversationHistory = [];
        let conversationId = 'conv_' + Date.now();
        let recognition = null;
        let isListening = false;
        let finalTranscriptBuffer = '';
        let speechSynthesis = window.speechSynthesis;
        let isSpeaking = false;
        let silenceTimer = null;
        let lastSpeechTime = 0;
        let voicesLoaded = false;
        let speechEnabled = false;
        let userName = '';

        document.addEventListener('DOMContentLoaded', function() {
            console.log('🎓 helloIVY Career Selector - Initializing...');
            startTimer();
            initializeAudio();
            setupTextInput();

            if (!('webkitSpeechRecognition' in window) && !('SpeechRecognition' in window)) {
                document.getElementById('speechWarning').style.display = 'block';
                switchToTextMode();
            }

            setTimeout(() => startInitialGreeting(), 3000);
        });

        function switchToVoiceMode() {
            if (!('webkitSpeechRecognition' in window) && !('SpeechRecognition' in window)) {
                alert('Speech recognition not supported. Use text input.');
                return;
            }
            currentInputMode = 'voice';
            document.getElementById('voiceModeBtn').classList.add('active');
            document.getElementById('textModeBtn').classList.remove('active');
            document.getElementById('voiceControls').style.display = 'flex';
            document.getElementById('textControls').style.display = 'none';
            document.getElementById('liveTranscript').textContent = 'Click the microphone when ready to speak!';
            updateStatus('Voice mode active', 'Click the microphone to start speaking');
        }

        function switchToTextMode() {
            currentInputMode = 'text';
            if (isRecording) stopRecording();
            document.getElementById('textModeBtn').classList.add('active');
            document.getElementById('voiceModeBtn').classList.remove('active');
            document.getElementById('textControls').style.display = 'flex';
            document.getElementById('voiceControls').style.display = 'none';
            document.getElementById('liveTranscript').textContent = 'Text mode active - type your response below';
            updateStatus('Text mode active', 'Type your response in the text box below');
            setTimeout(() => document.getElementById('textInput').focus(), 100);
        }

        function setupTextInput() {
            const textInput = document.getElementById('textInput');
            const sendBtn = document.getElementById('textSendBtn');
            textInput.addEventListener('input', function() {
                sendBtn.disabled = !this.value.trim().length > 0;
                this.style.height = 'auto';
                this.style.height = Math.min(this.scrollHeight, 150) + 'px';
            });
            textInput.addEventListener('keydown', function(event) {
                if (event.key === 'Enter' && !event.shiftKey) {
                    event.preventDefault();
                    if (this.value.trim()) sendTextMessage();
                }
            });
            textInput.addEventListener('paste', function() {
                setTimeout(() => sendBtn.disabled = !this.value.trim().length > 0, 0);
            });
        }

        async function sendTextMessage() {
    const textInput = document.getElementById('textInput');
    const message = textInput.value.trim();
    if (!message) return;
    textInput.disabled = true;
    document.getElementById('textSendBtn').disabled = true;
    textInput.value = '';
    textInput.style.height = 'auto';
    updateStatus('Processing your message...', 'Getting AI response');
    try {
        addMessage('user', message);
        showTypingIndicator();
        const response = await fetch('/api/voice-respond', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ message: message, conversation_id: conversationId })
        });
        const result = await response.json();
        if (result.success && result.ai_response && result.ai_response.trim()) {
            hideTypingIndicator();
            setTimeout(() => {
                addMessage('ai', result.ai_response);

                // FIX: Always call updateNotes and use 'message' as the transcript argument.
                console.log("DEBUG - Notes from API:", result.notes);
                updateNotes(message, result.ai_response, result.notes);

                if (!userName && conversationHistory.length <= 2) userName = extractUserName(message);
                // if (speechEnabled) forceBrowserTTS(result.ai_response);
                else {
                    updateMicButtonState('ready');
                    updateLiveTranscript('Click to continue', 'normal');
                    updateStatus('Ready', 'Click microphone when ready');
                }
            }, 300);
        } else if (result.error && result.error.toLowerCase().includes('no speech detected')) {
            // Handle "No speech detected" more gracefully
            hideTypingIndicator();
            updateMicButtonState('ready');
            updateLiveTranscript('No speech detected. Please try again and speak clearly into the mic.', 'error');
            updateStatus('No speech detected', 'Please click the mic and try again.');
        } else {
            hideTypingIndicator();
            const errorMsg = result.error || "AI did not reply. Please try again.";
            addMessage('ai', `<span style="color:#e53e3e;font-weight:600;">${errorMsg}</span>`);
            updateMicButtonState('ready');
            updateLiveTranscript(errorMsg, 'error');
            updateStatus('Error', errorMsg);
        }
    } catch (error) {
        hideTypingIndicator();
        console.error('Error:', error);
        updateStatus('Connection error', 'Please check internet and try again');
    } finally {
        textInput.disabled = false;
        textInput.focus();
    }
}


        function startTimer() {
            setInterval(() => {
                const elapsed = Date.now() - sessionStartTime;
                const minutes = Math.floor(elapsed / 60000);
                const seconds = Math.floor((elapsed % 60000) / 1000);
                document.getElementById('sessionTimer').textContent =
                    minutes.toString().padStart(2, '0') + ':' + seconds.toString().padStart(2, '0') + ' mins';
            }, 1000);
        }

        async function initializeAudio() {
            console.log('🎓 Initializing audio...');
            try {
                const stream = await navigator.mediaDevices.getUserMedia({ audio: true });
                stream.getTracks().forEach(track => track.stop());
                setupSpeechRecognition();
                setupSpeechSynthesis();
                updateLiveTranscript('Audio systems ready! Choose input to start...', 'normal');
                updateMicButtonState('ready');
            } catch (error) {
                console.error('❌ Microphone error:', error);
                handleMicrophoneError(error);
                switchToTextMode();
            }
        }

        function handleMicrophoneError(error) {
            let errorMessage = 'Microphone access required';
            let errorDetails = 'Please allow access and refresh';
            if (error.name === 'NotFoundError') {
                errorMessage = 'No microphone found';
                errorDetails = 'Connect a microphone and refresh';
            } else if (error.name === 'NotAllowedError') {
                errorMessage = 'Permission denied';
                errorDetails = 'Allow microphone in browser settings';
            }
            updateLiveTranscript(errorMessage, 'error');
            updateStatus(errorMessage, errorDetails);
            document.getElementById('speechWarning').style.display = 'block';
        }

        function setupSpeechSynthesis() {
            if (!speechSynthesis) {
                console.warn('⚠️ Speech synthesis not supported');
                speechEnabled = false;
                return;
            }
            function loadVoices() {
                const voices = speechSynthesis.getVoices();
                if (voices.length > 0) {
                    voicesLoaded = true;
                    speechEnabled = true;
                    console.log('✅ Speech ready with', voices.length, 'voices');
                } else console.log('⚠️ No voices yet');
            }
            loadVoices();
            if (speechSynthesis.onvoiceschanged !== undefined) speechSynthesis.onvoiceschanged = loadVoices;
            setTimeout(() => { if (!voicesLoaded) { loadVoices(); speechEnabled = true; } }, 1000);
            setTimeout(() => { if (!voicesLoaded) { speechEnabled = true; } }, 3000);
        }

        function setupSpeechRecognition() {
            if (!('webkitSpeechRecognition' in window) && !('SpeechRecognition' in window)) {
                console.error('❌ Speech not supported');
                updateLiveTranscript('Speech not supported', 'error');
                document.getElementById('speechWarning').style.display = 'block';
                return;
            }
            const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
            recognition = new SpeechRecognition();
            recognition.continuous = true;
            recognition.interimResults = true;
            recognition.lang = 'en-US';
            recognition.maxAlternatives = 1;
            recognition.onstart = function() { isListening = true; console.log('🎤 Started'); updateLiveTranscript('Listening...', 'listening'); };
            recognition.onresult = function(event) {
                let interimTranscript = '';
                let finalTranscript = '';
                for (let i = event.resultIndex; i < event.results.length; i++) {
                    const transcript = event.results[i][0].transcript;
                    if (event.results[i].isFinal) {
                        finalTranscript += transcript;
                        finalTranscriptBuffer += transcript + ' ';
                        lastSpeechTime = Date.now();
                    } else {
                        interimTranscript += transcript;
                        lastSpeechTime = Date.now();
                    }
                }
                const displayText = finalTranscriptBuffer + (interimTranscript ? `<span style="color: #a0aec0; font-style: italic;">${interimTranscript}</span>` : '');
                updateLiveTranscript(displayText || 'Listening...', 'listening');
                if (isRecording && (finalTranscript || interimTranscript)) {
                    clearTimeout(silenceTimer);
                    silenceTimer = setTimeout(() => {
                        if (isRecording && Date.now() - lastSpeechTime >= 3000) stopRecording();
                    }, 3000);
                }
            };
            recognition.onerror = function(event) {
                console.error('Error:', event.error);
                if (event.error === 'not-allowed') {
                    updateLiveTranscript('Access denied. Allow microphone.', 'error');
                    handleMicrophoneError({ name: 'NotAllowedError' });
                } else if (event.error === 'no-speech') console.log('No speech');
                else updateLiveTranscript(`Error: ${event.error}`, 'error');
            };
            recognition.onend = function() {
                isListening = false;
                console.log('🔇 Ended');
                if (isRecording) setTimeout(() => { if (isRecording && !isSpeaking) recognition.start(); }, 100);
            };
            console.log('✅ Speech initialized');
        }

        function startInitialGreeting() {
            const greeting = "Hey there! I’m thrilled to be your helloIVY Career Selector buddy! Let’s explore awesome careers for kids aged 10-22. What’s your name?";
            forceBrowserTTS(greeting);
        }

        function forceBrowserTTS(text) {
            if (!speechSynthesis) return;
            speechSynthesis.cancel();
            setTimeout(() => {
                const utterance = new SpeechSynthesisUtterance(text);
                utterance.rate = 1.0;
                utterance.pitch = 1.0;
                utterance.volume = 1.0;
                utterance.lang = 'en-US';
                const voices = speechSynthesis.getVoices();
                if (voices.length > 0) utterance.voice = voices.find(voice => voice.lang.includes('en')) || voices[0];
                utterance.onstart = function() { isSpeaking = true; updateMicButtonState('speaking'); updateLiveTranscript('🔊 AI is speaking...', 'speaking'); updateStatus('AI is speaking...', 'Listen to the AI coach'); };
                utterance.onend = function() { isSpeaking = false; setTimeout(() => { if (!isSpeaking && !isRecording && currentInputMode === 'voice') startAutoListening(); else if (currentInputMode === 'text') { updateMicButtonState('ready'); updateLiveTranscript('AI finished - continue with text', 'normal'); updateStatus('Ready', 'Type below'); document.getElementById('textInput').focus(); } }, 800); };
                utterance.onerror = function() { isSpeaking = false; updateMicButtonState('ready'); if (currentInputMode === 'text') { updateStatus('Ready', 'Type below'); document.getElementById('textInput').focus(); } };
                speechSynthesis.speak(utterance);
                setTimeout(() => { if (speechSynthesis.speaking) console.log('✅ Speaking'); else console.log('❌ Not speaking'); }, 500);
            }, 300);
        }

        function updateMicButtonState(state) {
            const micButton = document.getElementById('micButton');
            micButton.classList.remove('recording', 'processing', 'speaking', 'auto-listening');
            switch(state) {
                case 'speaking': micButton.classList.add('speaking'); micButton.innerHTML = '🔊'; break;
                case 'auto-listening': micButton.classList.add('auto-listening'); micButton.innerHTML = '🎤'; break;
                case 'recording': micButton.classList.add('recording'); micButton.innerHTML = '⏸️'; break;
                case 'processing': micButton.classList.add('processing'); micButton.innerHTML = '⏳'; break;
                case 'ready': default: micButton.innerHTML = '🎤'; break;
            }
        }

        function updateLiveTranscript(text, status = 'normal') {
            const transcriptElement = document.getElementById('liveTranscript');
            if (transcriptElement) {
                transcriptElement.innerHTML = text;
                transcriptElement.className = `transcript-text ${status}`;
            }
        }

        function updateStatus(mainText, subText = '') {
            document.getElementById('statusText').textContent = mainText;
            if (subText) document.getElementById('statusSubtext').textContent = subText;
        }

        async function toggleRecording() {
            if (currentInputMode !== 'voice') {
                switchToVoiceMode();
                return;
            }
            if (isSpeaking) {
                speechSynthesis.cancel();
                stopCurrentAudio();
                await new Promise(resolve => setTimeout(resolve, 300));
                startRecording();
            } else if (isRecording) {
                stopRecording();
            } else {
                await startRecording();
            }
        }

        async function startRecording(isAutoMode = false) {
            if (!recognition) {
                console.error('❌ Speech not available');
                updateLiveTranscript('Speech not available', 'error');
                return;
            }
            if (isSpeaking) {
                speechSynthesis.cancel();
                stopCurrentAudio();
                isSpeaking = false;
            }
            isRecording = true;
            finalTranscriptBuffer = '';
            lastSpeechTime = Date.now();
            updateMicButtonState('recording');
            updateStatus('Recording...', 'Speak naturally, I’ll detect when you’re done');
            recognition.start();
            updateLiveTranscript('Listening...', 'listening');
            console.log('🎤 Recording started' + (isAutoMode ? ' (auto-mode)' : ''));
        }

        function stopRecording() {
            isRecording = false;
            clearTimeout(silenceTimer);
            updateMicButtonState('processing');
            updateStatus('Processing your response...', 'Getting AI response');
            if (recognition && isListening) recognition.stop();
            updateLiveTranscript('Processing...', 'processing');
            if (finalTranscriptBuffer.trim()) processTranscript(finalTranscriptBuffer.trim());
            else setTimeout(() => { updateMicButtonState('ready'); updateLiveTranscript('No speech detected. Try again.', 'normal'); updateStatus('No speech', 'Click microphone to retry'); }, 1500);
        }

<!--        async function processTranscript(transcript) {-->
<!--            if (!transcript.trim()) return;-->
<!--            try {-->
<!--                addMessage('user', transcript);-->
<!--                showTypingIndicator();-->
<!--                const response = await fetch('/api/voice-respond', {-->
<!--                    method: 'POST',-->
<!--                    headers: { 'Content-Type': 'application/json' },-->
<!--                    body: JSON.stringify({ message: transcript, conversation_id: conversationId })-->
<!--                });-->
<!--                const result = await response.json();-->
<!--                if (result.success && result.ai_response && result.ai_response.trim()) {-->
<!--    hideTypingIndicator();-->
<!--    setTimeout(() => {-->
<!--        addMessage('ai', result.ai_response);-->
<!--        updateNotes(transcript, result.ai_response, result.notes);-->
<!--        if (!userName && conversationHistory.length <= 2) userName = extractUserName(transcript);-->
<!--        // if (speechEnabled) forceBrowserTTS(result.ai_response);-->
<!--        else { updateMicButtonState('ready'); updateLiveTranscript('Click to continue', 'normal'); updateStatus('Ready', 'Click microphone when ready'); }-->
<!--    }, 300);-->
<!--} else {-->
<!--    hideTypingIndicator();-->
<!--    const errorMsg = result.error || "AI did not reply. Please try again.";-->
<!--    addMessage('ai', `<span style="color:#e53e3e;font-weight:600;">${errorMsg}</span>`);-->
<!--    updateMicButtonState('ready');-->
<!--    updateLiveTranscript(errorMsg, 'error');-->
<!--    updateStatus('Error', errorMsg);-->
<!--}-->

<!--            } catch (error) {-->
<!--                hideTypingIndicator();-->
<!--                console.error('Error:', error);-->
<!--                updateMicButtonState('ready');-->
<!--                updateLiveTranscript('Error processing', 'error');-->
<!--                updateStatus('Connection error', 'Check internet and try again');-->
<!--            }-->
<!--        }-->

        function addMessage(sender, content) {
            const messagesContainer = document.getElementById('messagesContainer');
            const messageDiv = document.createElement('div');
            messageDiv.className = 'message ' + sender;
            messageDiv.style.animationDelay = '0.1s';
            const avatar = sender === 'user' ? 'YOU' : 'AI';
            const avatarClass = sender === 'user' ? 'user-avatar' : 'ai-avatar';
            const time = new Date().toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' });
            messageDiv.innerHTML = `
                <div class="avatar ${avatarClass}">${avatar}</div>
                <div class="message-content">
                    <div class="message-text">${content}</div>
                    <div class="message-time">${time}</div>
                </div>
            `;
            messagesContainer.appendChild(messageDiv);
            messagesContainer.scrollTop = messagesContainer.scrollHeight;
            conversationHistory.push({ role: sender, content: content });
        }

        function showTypingIndicator() {
            document.getElementById('typingIndicator').classList.add('active');
        }

        function hideTypingIndicator() {
            document.getElementById('typingIndicator').classList.remove('active');
        }

        function extractUserName(message) {
            const patterns = [/my name is (\w+)/i, /i'm (\w+)/i, /i am (\w+)/i, /call me (\w+)/i, /name's (\w+)/i, /this is (\w+)/i];
            for (const pattern of patterns) {
                const match = message.match(pattern);
                if (match && match[1]) return match[1].charAt(0).toUpperCase() + match[1].slice(1);
            }
            return '';
        }

<!--        function updateNotes(userMessage, aiResponse, serverNotes) {-->
<!--    const notesContent = document.getElementById('notesContent');-->
<!--    // Remove all current notes (but keep placeholder if present)-->
<!--    notesContent.innerHTML = '';-->

<!--    // If there are notes, add them-->
<!--    if (serverNotes && serverNotes.length > 0) {-->
<!--        serverNotes.forEach(note => {-->
<!--            const noteDiv = document.createElement('div');-->
<!--            noteDiv.className = 'note-item';-->
<!--            noteDiv.textContent = note;-->
<!--            notesContent.appendChild(noteDiv);-->
<!--            noteDiv.style.opacity = '0';-->
<!--            noteDiv.style.transform = 'translateY(10px)';-->
<!--            setTimeout(() => {-->
<!--                noteDiv.style.transition = 'all 0.3s ease';-->
<!--                noteDiv.style.opacity = '1';-->
<!--                noteDiv.style.transform = 'translateY(0)';-->
<!--            }, 100);-->
<!--        });-->
<!--    } else {-->
<!--        // Show the placeholder if no notes-->
<!--        const placeholderDiv = document.createElement('div');-->
<!--        placeholderDiv.className = 'note-placeholder';-->
<!--        placeholderDiv.textContent = 'Notes will appear here as we chat...';-->
<!--        notesContent.appendChild(placeholderDiv);-->
<!--    }-->
<!--}-->
        function updateNotes(userMessage, aiResponse, serverNotes) {
    const notesContent = document.getElementById('notesContent');
    // Clear all current notes
    notesContent.innerHTML = '';

    // If there are notes, add them
    if (serverNotes && serverNotes.length > 0) {
        serverNotes.forEach(note => {
            const noteDiv = document.createElement('div');
            noteDiv.className = 'note-item';
            noteDiv.textContent = note;
            notesContent.appendChild(noteDiv);
            noteDiv.style.opacity = '0';
            noteDiv.style.transform = 'translateY(10px)';
            setTimeout(() => {
                noteDiv.style.transition = 'all 0.3s ease';
                noteDiv.style.opacity = '1';
                noteDiv.style.transform = 'translateY(0)';
            }, 100);
        });
    } else {
        // Show the placeholder if no notes
        const placeholderDiv = document.createElement('div');
        placeholderDiv.className = 'note-placeholder';
        placeholderDiv.textContent = 'Notes will appear here as we chat...';
        notesContent.appendChild(placeholderDiv);
    }
}


        async function generateCareerPlan() {
            const generateBtn = document.getElementById('generateCareerPlanBtn');
            generateBtn.disabled = true;
            generateBtn.innerHTML = '<span>⏳</span><span>Creating your career plan...</span>';
            generateBtn.style.background = 'linear-gradient(135deg, #fbb86f, #ed8936)';
            try {
                const response = await fetch('/api/generate-career-plan', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ conversation_id: conversationId })
                });
                const result = await response.json();
                if (result.success) {
                    generateBtn.innerHTML = '<span>✨</span><span>Plan Generated Successfully!</span>';
                    generateBtn.style.background = 'linear-gradient(135deg, #48bb78, #38a169)';
                    const planPreview = `
Career Plan Generated! 📝

Title: "${result.title}"
Details: ${result.plan.substring(0, 300)}...

Your complete plan is saved and viewable in the Dashboard.
                    `;
                    alert(planPreview);
                    if (speechEnabled) speakText("Congratulations! I've created your career plan based on our conversation. Check it in your dashboard!");
                } else throw new Error(result.error || 'Plan generation failed');
            } catch (error) {
                console.error('Error:', error);
                generateBtn.innerHTML = '<span>⚠️</span><span>Error generating plan - Try again</span>';
                generateBtn.style.background = 'linear-gradient(135deg, #fc8181, #f56565)';
                setTimeout(() => { generateBtn.disabled = false; generateBtn.innerHTML = '<span>✨</span><span>Generate Your Career Plan!</span>'; generateBtn.style.background = 'linear-gradient(135deg, #48bb78, #38a169)'; }, 3000);
            }
        }

        document.addEventListener('keydown', function(event) {
            if (event.code === 'Space' && !event.target.matches('input, textarea') && currentInputMode === 'voice') {
                event.preventDefault();
                toggleRecording();
            }
            if (event.code === 'Escape' && isRecording) {
                event.preventDefault();
                stopRecording();
            }
            if ((event.ctrlKey || event.metaKey) && event.key === 'Enter' && currentInputMode === 'text') {
                event.preventDefault();
                const textInput = document.getElementById('textInput');
                if (textInput.value.trim()) sendTextMessage();
            }
            if (event.key === 'Tab' && event.altKey) {
                event.preventDefault();
                if (currentInputMode === 'voice') switchToTextMode(); else switchToVoiceMode();
            }
        });

        window.addEventListener('beforeunload', function(event) {
            if (isRecording) {
                event.preventDefault();
                event.returnValue = 'Recording in progress. Leave?';
                return event.returnValue;
            }
        });

        document.addEventListener('visibilitychange', function() {
            if (document.hidden && isRecording) stopRecording();
        });

        function smoothScrollToBottom() {
            const container = document.getElementById('messagesContainer');
            container.scrollTo({ top: container.scrollHeight, behavior: 'smooth' });
        }
        const originalAddMessage = addMessage;
        addMessage = function(sender, content) {
            originalAddMessage(sender, content);
            setTimeout(smoothScrollToBottom, 100);
        };

        function stopCurrentAudio() {
            if (speechSynthesis.speaking) speechSynthesis.cancel();
            isSpeaking = false;
            console.log('🔇 Audio stopped');
        }

        function startAutoListening() {
            if (isSpeaking || isRecording || currentInputMode !== 'voice') return;
            updateMicButtonState('auto-listening');
            updateLiveTranscript('Ready to listen... Start speaking!', 'listening');
            updateStatus('Ready to listen!', 'Start speaking and I’ll detect when done');
            setTimeout(() => { if (!isSpeaking && !isRecording && currentInputMode === 'voice') startRecording(true); }, 1000);
        }
    </script>
</body>
</html>
